name: Docker Build and Deploy

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build Docker image
        run: |
          docker build -f Roulette/Dockerfile -t lanctole/roulette:${{ github.sha }} .

      - name: Push Docker image to Docker Hub
        run: docker push lanctole/roulette:${{ github.sha }}

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Decode secrets and set environment variables
        env:
          APP_SECRETS: ${{ secrets.APP_SECRETS }}
        run: |
          echo "$APP_SECRETS" | jq -r 'to_entries[] | "\(.key)=\(.value)"' > .env

      - name: Deploy to server using SSH
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "$APP_SECRETS" > /tmp/app_secrets.json
            if [ ! -f /tmp/app_secrets.json ]; then
              echo ".env file not found"
              exit 1
            fi
            jq -r 'to_entries[] | "\(.key)=\(.value)"' /tmp/app_secrets.json > /tmp/.env
            set -a
            source .env
            set +a
            
            docker pull lanctole/roulette:${{ github.sha }}
            
            docker stop roulette_app || true
            docker rm roulette_app || true
            
            docker run -d --name roulette_app \
              -p 5000:8080 \
              -e ConnectionStrings__DefaultConnection="$ConnectionStrings__DefaultConnection" \
              -e Logging__LogLevel__Default="$Logging__LogLevel__Default" \
              -e Logging__LogLevel__Microsoft_AspNetCore="$Logging__LogLevel__Microsoft_AspNetCore" \
              -e AllowedHosts="$AllowedHosts" \
              -e Auth__Scope="$Auth__Scope" \
              -e Auth__Access="$Auth__Access" \
              -e Auth__Refresh="$Auth__Refresh" \
              -e Auth__Name="$Auth__Name" \
              -e Auth__ClientId="$Auth__ClientId" \
              -e Auth__ClientSecret="$Auth__ClientSecret" \
              -e Auth__UserId="$Auth__UserId" \
              -e Smtp__Host="$Smtp__Host" \
              -e Smtp__Port="$Smtp__Port" \
              -e Smtp__EnableSsl="$Smtp__EnableSsl" \
              -e Smtp__Username="$Smtp__Username" \
              -e Smtp__Password="$Smtp__Password" \
              -e Smtp__FromEmail="$Smtp__FromEmail" \
              -e Redis__Configuration="$Redis__Configuration" \
              -e Redis__InstanceName="$Redis__InstanceName" \
              -e Authentication__Yandex__ClientId="$Authentication__Yandex__ClientId" \
              -e Authentication__Yandex__ClientSecret="$Authentication__Yandex__ClientSecret" \
              -e ApiBaseAddress="$ApiBaseAddress" \
              -e Shikimori__BaseUrl="$Shikimori__BaseUrl" \
              lanctole/roulette:${{ github.sha }}
