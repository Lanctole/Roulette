@using ShikimoriSharp.Bases
@inject ApiClientService ApiClientService

@code {

        protected string? SelectedScore;
        protected string? SelectedFromYear;
        protected string? SelectedToYear;
        protected string? Season;
        protected bool GetDetailedData;
        protected List<string> SelectedGenres = new();
    protected readonly string SelectedOrder = "random";
        protected readonly int Limit = 5;
        protected readonly int Page = 1;

        protected void OnSelectedGenresChanged(List<string> selectedGenres)
        {
            SelectedGenres = selectedGenres;
        }

        protected async Task<List<SmallRepresentation>> GetMediaItemsAsync(string endpoint, Func<long, Task<SmallRepresentation>> getDetailsFunc = null)
        {
            try
            {
                Season = $"{SelectedFromYear}";
                if (!string.IsNullOrEmpty(SelectedToYear))
                {
                    Season += $"_{SelectedToYear}";
                }
                string genres = string.Join(",", SelectedGenres);

                var url = $"{endpoint}" +
                          $"score={SelectedScore}&" +
                          $"season={Season}&" +
                          $"genre={genres}&" +
                          $"order={SelectedOrder}&" +
                          $"limit={Limit}&" +
                          $"page={Page}";

                var items = await ApiClientService.GetAsync<List<SmallRepresentation>>(url);

                if (GetDetailedData && getDetailsFunc != null)
                {
                    var detailedItems = new List<SmallRepresentation>();
                    foreach (var item in items)
                    {
                        var detailedItem = await getDetailsFunc(item.Id);
                        detailedItems.Add(detailedItem);
                    }
                    return detailedItems;
                }

                return items;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error in GetMediaItemsAsync: {ex.Message}");
                throw;
            }
        }
    
}
