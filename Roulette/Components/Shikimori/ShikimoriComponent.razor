@using ShikimoriSharp.Bases
@using Roulette.Services
@inject ApiClientService ApiClientService
@inject NotificationService _notice
@inject IJSRuntime JS

@code {
    protected string? SelectedScore;
    protected string? SelectedFromYear;
    protected string? SelectedToYear;
    protected double dateFrom;
    protected double dateTo;
    protected (double, double) defaultDate = (1995, 2024);
    protected string? Season;
    protected bool GetDetailedData;
    protected List<string> SelectedGenres = new();
    protected readonly string SelectedOrder = "random";
    protected readonly int Limit = 5;
    protected readonly int Page = 1;

    protected override async Task OnInitializedAsync()
    {
        (dateFrom, dateTo) = defaultDate;
    }

    protected void OnSelectedGenresChanged(List<string> selectedGenres)
    {
        SelectedGenres = selectedGenres;
    }

    private async Task OnEmptyAnswer()
    {
        RenderFragment customIcon = @<Icon Type="meh" Theme="outline" Style="color:#FFC000;"></Icon>;
        await _notice.Open(new NotificationConfig
        {
            Message = "Проблем-ка!",
            Description = "К сожалению, у нас нет контента удовлетворяющего вашим запросам. Попробуйте изменить хотелки",
            Icon = customIcon
        });
    }


    protected async Task<List<SmallRepresentation>> GetMediaItemsAsync(string endpoint, Func<long, Task<SmallRepresentation>> getDetailsFunc)
    {
        try
        {
            SelectedFromYear = dateFrom.ToString();
            SelectedToYear = dateTo.ToString();
            Season = $"{SelectedFromYear}";
            if (!string.IsNullOrEmpty(SelectedToYear))
            {
                Season += $"_{SelectedToYear}";
            }
            var genres = string.Join(",", SelectedGenres);

            var url = $"{endpoint}" +
                      $"score={SelectedScore}&" +
                      $"season={Season}&" +
                      $"genre={genres}&" +
                      $"order={SelectedOrder}&" +
                      $"limit={Limit}&" +
                      $"page={Page}";

            var items = await ApiClientService.GetAsync<List<SmallRepresentation>>(url);
            if (items == null || items.Count == 0)
            {
                await OnEmptyAnswer();
                return new List<SmallRepresentation>();
            }

            var detailedItems = new List<SmallRepresentation>();
            foreach (var item in items)
            {
                var detailedItem = await getDetailsFunc(item.Id);
                detailedItems.Add(detailedItem);
            }
            TransferMediaPropsToSpinFunc(detailedItems);
            return detailedItems;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in GetMediaItemsAsync: {ex.Message}");
            throw;
        }
    }

    private void TransferMediaPropsToSpinFunc(List<SmallRepresentation> detailedItems)
    {
        Dictionary<long, string> mediaName = new();
        foreach (var media in detailedItems)
        {
            mediaName.Add(media.Id, media.Russian != "" ? media.Russian : media.Name);
        }
        JS.InvokeVoidAsync("startSpin", mediaName);
    }

    protected void HandleDateSliderChange((double, double) newValue)
    {
        (dateFrom, dateTo) = newValue;
    }
}