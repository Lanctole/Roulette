@page "/shome"
@using ShikimoriSharp.Classes
@using ShikimoriSharp.Settings
@using Roulette.Models
@using Microsoft.IdentityModel.Tokens
@using ShikimoriSharp.Bases
@using System.Collections.Generic
@using ShikimoriSharp.Information
@using Genres = Roulette.Components.Pages.Shikimori.Genres
@using Studios = Roulette.Components.Pages.Shikimori.Studios
@using AnimeList = Roulette.Components.Pages.Shikimori.AnimeList
@inject ApiClientService ApiClientService

<PageTitle>Shikimori</PageTitle>

<Row Gutter="16">
    <Col Xs="24" Sm="12" Md="8">
    <Genres SelectedGenresChanged="OnSelectedGenresChanged" />
    </Col>
    <Col Xs="24" Sm="12" Md="8">
    <MinimalScoreComponent @bind-SelectedScore="_selectedScore"  />
    </Col>
    <Col Xs="24" Sm="12" Md="8">
    <RatingComponent @bind-SelectedValue="_selectedRating" />
    </Col>
</Row>
<Divider Orientation="left"></Divider>

<Row Gutter="16">
    <Col Xs="24" Sm="12" Md="8">
    <DurationComponent @bind-SelectedValue="_selectedDuration" />
    </Col>
    <Col Xs="24" Sm="12" Md="8">
    <Studios SelectedStudiosChanged="OnSelectedStudiosChanged" />
    </Col>
    <Col Xs="24" Sm="12" Md="8">
    <SelectKindComponent @bind-SelectedValue="_selectedKind" />
    </Col>
</Row>
<Divider Orientation="left"></Divider>

<YearSelectionComponent @bind-selectedFromYear="_selectedFromYear" @bind-selectedToYear="_selectedToYear" />


<p>Временной период: с @_selectedFromYear до @_selectedToYear</p>

<Button OnClick="SendSelected">Roll!</Button> <Checkbox @bind-Value="_getDetailedData">
    Получить полные данные
</Checkbox>

<AnimeList MediaItems="_animes" />

@code {
    private string? _selectedScore;
    private string? _selectedFromYear;
    private string? _selectedToYear;
    private string? _season;
    private string? _selectedRating;
    private string? _selectedKind;
    private string? _selectedDuration;
    private bool _getDetailedData;
    private List<string> _selectedGenres = new();
    private List<string> _selectedStudios = new();
    private readonly string _selectedOrder ="random";
    private readonly int _limit = 5;
    private readonly int _page = 1;
    private List<SmallRepresentation>? _animes;

    private void OnSelectedGenresChanged(List<string> selectedGenres)
    {
        _selectedGenres = selectedGenres;
    }
    private void OnSelectedStudiosChanged(List<string> selectedStudios)
    {
        _selectedStudios = selectedStudios;
    }
    
    private async Task<List<SmallRepresentation>> SendSelected()
    {
        try
        {
        _season = $"{_selectedFromYear}";
        if (!_selectedToYear.IsNullOrEmpty())
        {
            _season += $"_{ _selectedToYear}";
        }
        string genres = string.Join(",", _selectedGenres);
        string studios = string.Join(",", _selectedStudios);

        var url = "anime/animes?" +
                  $"score={_selectedScore}&" +
                  $"rating={ _selectedRating}&" +
                  $"kind={_selectedKind}&" +
                  $"season={_season}&" +
                  $"studio={studios}&" +
                  $"genre={genres}&" +
                  $"duration={_selectedDuration}&" +
                  $"order={_selectedOrder}&" +
                  $"limit={_limit}&" +
                  $"page={_page}";
            Console.WriteLine("SendSelected before GetAnymesAsync");
        var animes = await ApiClientService.GetAnimesAsync(url);
            Console.WriteLine("SendSelected after GetAnymesAsync");
            Console.WriteLine("--------------------------------------------------------------------------------------------------");

            if (_getDetailedData)
            {
                var detailedAnimes = new List<AnimeId>();
                foreach (var anime in animes)
                {
                    url = $"anime/animes/{anime.Id}";
                    var detailedAnime = await ApiClientService.GetAnimeByIdAsync(url);
                    detailedAnimes.Add(detailedAnime);
                }
                _animes = new List<SmallRepresentation>(detailedAnimes);
                
            }
            else
            {
                _animes = new List<SmallRepresentation>(animes);
            }
            return _animes;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in SendSelected: {ex.Message}");
            throw;
        }
        
    }
}